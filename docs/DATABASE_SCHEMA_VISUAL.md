# Torre Tempo V4 - Database Schema Visual Documentation

**Version**: 4.0.0  
**Last Updated**: February 8, 2026  
**Total Tables**: 32  
**Database**: PostgreSQL 16

---

## üìä Overview

Torre Tempo V4 uses PostgreSQL 16 with Row-Level Security (RLS) for multi-tenant isolation. The database architecture is designed for Spanish labor law compliance, audit readiness, and inspector access.

### Key Features

- üõ°Ô∏è **RLS Protection**: 12 tables with tenant isolation policies
- üîê **Encryption**: 6 PII fields in `employee_profiles` (AES-256-GCM)
- üîó **Audit Trail**: SHA-256 hash chain for immutability
- üìä **Compliance**: Spanish labor law enforcement (Estatuto de los Trabajadores)
- üîç **Inspector API**: Read-only token-based access for ITSS audits

---

## üìã Table Categories

### Better Auth Tables (7)

| Table | Purpose | RLS | Records |
|-------|---------|-----|---------|
| `user` | User accounts and authentication | ‚ùå | ~100-1000 |
| `session` | Active user sessions (15-min expiry) | ‚ùå | ~50-200 |
| `account` | OAuth provider accounts | ‚ùå | ~100-1000 |
| `verification` | Email verification tokens | ‚ùå | ~10-50 |
| `organization` | Tenant organizations | ‚ùå | ~10-100 |
| `member` | Organization membership + roles | ‚ùå | ~100-1000 |
| `invitation` | Pending organization invites | ‚ùå | ~5-50 |

**Notes**:
- Auto-generated by Better Auth v1.1.5
- `member` table includes custom `clock_in_pin` field (hashed 4-digit PIN)
- `user` table includes admin plugin fields: `role`, `banned`, `banReason`, `banExpires`

---

### Business Logic Tables (19)

| Table | Purpose | RLS | Encrypted | Records |
|-------|---------|-----|-----------|---------|
| `locations` | Work sites with geofencing | ‚úÖ | ‚ùå | ~5-50 |
| `feature_flags` | Platform-wide feature toggles | ‚ùå | ‚ùå | ~10-50 |
| `member_skills` | Skills junction table | ‚ùå | ‚ùå | ~100-500 |
| `availability` | Recurring availability patterns | ‚úÖ | ‚ùå | ~500-2000 |
| `shift_templates` | Reusable shift templates | ‚úÖ | ‚ùå | ~10-50 |
| `shifts` | Roster shifts (draft ‚Üí published) | ‚úÖ | ‚ùå | ~1000-10000 |
| `swap_requests` | Peer + manager approval flow | ‚úÖ | ‚ùå | ~50-500 |
| `notifications` | In-app notifications | ‚úÖ | ‚ùå | ~1000-10000 |
| `time_entries` | Clock in/out records | ‚úÖ | ‚ùå | ~5000-50000 |
| `break_entries` | Paid/unpaid breaks | ‚úÖ | ‚ùå | ~2000-20000 |
| `correction_requests` | Time entry corrections | ‚úÖ | ‚ùå | ~100-1000 |
| `monthly_summaries` | Auto-generated monthly PDFs | ‚úÖ | ‚ùå | ~100-1000 |
| `audit_log` | SHA-256 hash chain (immutable) | ‚úÖ | ‚ùå | ~10000-100000 |
| `admin_audit_log` | Platform admin actions | ‚ùå | ‚ùå | ~100-1000 |
| `error_logs` | Platform-wide error logging | ‚ùå | ‚ùå | ~1000-10000 |
| `inspector_tokens` | Time-limited ITSS access | ‚úÖ | ‚ùå | ~5-50 |
| `subscription_details` | Billing tiers (1 per org) | ‚ùå | ‚ùå | ~10-100 |
| `subscription_plans` | Available subscription plans | ‚ùå | ‚ùå | ~3-10 |
| `admin_broadcast_messages` | Platform-wide announcements | ‚ùå | ‚ùå | ~10-100 |

**Notes**:
- All RLS tables include `organization_id` for tenant isolation
- `audit_log` has REVOKE UPDATE/DELETE for immutability
- `shifts` supports draft/publish workflow with acknowledgment tracking

---

### New Tables - Week 1 Implementation (6)

| Table | Purpose | RLS | Encrypted | Records |
|-------|---------|-----|-----------|---------|
| `employee_profiles` üîê | Employment data + PII | ‚úÖ | ‚úÖ (6 fields) | ~100-1000 |
| `leave_requests` | Vacation/sick leave | ‚úÖ | ‚ùå | ~100-1000 |
| `generated_reports` | Audit trail for reports | ‚úÖ | ‚ùå | ~100-1000 |
| `compliance_checks` | Automated compliance logs | ‚úÖ | ‚ùå | ~1000-10000 |
| `notification_preferences` | User notification settings + DND | ‚ùå | ‚ùå | ~100-1000 |
| `organization_settings` | Per-org compliance policies | ‚ùå | ‚ùå | ~10-100 |

**Notes**:
- `employee_profiles` stores 6 encrypted PII fields (DNI, SSN, tax ID, phone, address, emergency contact)
- `leave_requests` supports half-days (e.g., 2.5 days) and doctor's note verification
- `compliance_checks` logs violations with Spanish law references (Estatuto de los Trabajadores)
- `notification_preferences` enforces Right to Disconnect (Ley Org√°nica 3/2018)
- `organization_settings` defaults to Spanish labor law limits (9h/day, 40h/week, 12h rest)

---

## üó∫Ô∏è Entity-Relationship Diagram

```mermaid
erDiagram
    %% Better Auth Core
    user ||--o{ session : has
    user ||--o{ account : has
    user ||--o{ member : belongs_to
    organization ||--o{ member : contains
    organization ||--o{ invitation : sends
    user ||--o{ invitation : invites
    
    %% Employee Profiles & Leave
    user ||--o| employee_profiles : has
    organization ||--o{ employee_profiles : contains
    employee_profiles ||--o{ leave_requests : creates
    user ||--o{ leave_requests : requests
    user ||--o{ leave_requests : approves
    locations ||--o{ employee_profiles : work_location
    
    %% Locations & Shifts
    organization ||--o{ locations : owns
    organization ||--o{ shift_templates : defines
    locations ||--o{ shift_templates : default_location
    shift_templates ||--o{ shifts : instantiates
    locations ||--o{ shifts : hosts
    user ||--o{ shifts : assigned_to
    user ||--o{ shifts : created_by
    
    %% Availability & Skills
    organization ||--o{ availability : defines
    user ||--o{ availability : declares
    member ||--o{ member_skills : has
    
    %% Shift Swaps
    organization ||--o{ swap_requests : manages
    user ||--o{ swap_requests : requests
    user ||--o{ swap_requests : receives
    user ||--o{ swap_requests : approves_as_manager
    shifts ||--o{ swap_requests : offered_shift
    shifts ||--o{ swap_requests : desired_shift
    
    %% Time Tracking
    organization ||--o{ time_entries : tracks
    user ||--o{ time_entries : clocks
    shifts ||--o{ time_entries : linked_to
    time_entries ||--o{ break_entries : contains
    time_entries ||--o{ correction_requests : corrects
    user ||--o{ correction_requests : requests
    user ||--o{ correction_requests : reviews
    
    %% Summaries & Reports
    organization ||--o{ monthly_summaries : generates
    user ||--o{ monthly_summaries : receives
    organization ||--o{ generated_reports : produces
    user ||--o{ generated_reports : generates
    inspector_tokens ||--o{ generated_reports : grants_access
    
    %% Compliance
    organization ||--o{ compliance_checks : monitors
    user ||--o{ compliance_checks : subject_of
    time_entries ||--o{ compliance_checks : triggers
    shifts ||--o{ compliance_checks : triggers
    user ||--o{ compliance_checks : resolves
    
    %% Notifications & Preferences
    organization ||--o{ notifications : sends
    user ||--o{ notifications : receives
    user ||--o| notification_preferences : configures
    
    %% Settings & Subscriptions
    organization ||--o| organization_settings : configures
    organization ||--o| subscription_details : subscribes
    subscription_plans ||--o{ subscription_details : defines
    
    %% Audit & Errors
    organization ||--o{ audit_log : logs
    user ||--o{ audit_log : actor
    user ||--o{ admin_audit_log : admin_actor
    organization ||--o{ inspector_tokens : issues
    user ||--o{ inspector_tokens : issues
    
    %% Admin Features
    user ||--o{ admin_broadcast_messages : sends
    
    %% Table Definitions (Key Fields Only)
    
    user {
        text id PK
        text name
        text email UK
        boolean emailVerified
        text role "admin plugin"
        boolean banned "admin plugin"
    }
    
    organization {
        text id PK
        text name
        text slug UK
        text logo
    }
    
    member {
        text id PK
        text organizationId FK
        text userId FK
        text role "employee|manager|tenantAdmin|owner"
        text clock_in_pin "hashed 4-digit PIN"
    }
    
    employee_profiles {
        uuid id PK
        text user_id FK
        text organization_id FK
        text dni_nie_encrypted "üîê AES-256-GCM"
        text social_security_number_encrypted "üîê"
        text tax_id_encrypted "üîê"
        text phone_number_encrypted "üîê"
        text address_encrypted "üîê JSONB"
        text emergency_contact_encrypted "üîê JSONB"
        timestamp date_of_birth
        varchar job_title
        varchar employment_type "indefinido|temporal|practicas|formacion"
        timestamp contract_start_date
        numeric working_hours_per_week
        numeric vacation_days_accrued
        numeric vacation_days_used
    }
    
    leave_requests {
        uuid id PK
        text user_id FK
        text organization_id FK
        varchar leave_type "vacation|sick|personal|unpaid"
        timestamp start_date
        timestamp end_date
        numeric days_count "supports half-days: 2.5"
        varchar status "pending|approved|rejected|cancelled"
        text approved_by FK
        text doctors_note_url
        boolean doctors_note_verified
    }
    
    locations {
        uuid id PK
        text organization_id FK
        varchar name
        text address
        numeric lat
        numeric lng
        integer geofence_radius "meters"
    }
    
    shift_templates {
        uuid id PK
        text organization_id FK
        varchar name "Morning Shift"
        varchar start_time "HH:mm"
        varchar end_time "HH:mm"
        integer break_minutes
        uuid location_id FK
        varchar color "hex"
        boolean is_active
    }
    
    shifts {
        uuid id PK
        text organization_id FK
        text user_id FK
        uuid location_id FK
        uuid template_id FK
        timestamp start_time
        timestamp end_time
        integer break_minutes
        varchar status "draft|published|completed|cancelled"
        boolean is_published
        timestamp published_at
        timestamp acknowledged_at
    }
    
    swap_requests {
        uuid id PK
        text organization_id FK
        text requester_id FK
        uuid offered_shift_id FK
        text recipient_id FK
        uuid desired_shift_id FK
        varchar status "pending_peer|pending_manager|approved|rejected|completed"
        text manager_id FK
        timestamp resolved_at
    }
    
    time_entries {
        uuid id PK
        text organization_id FK
        text user_id FK
        uuid linked_shift_id FK
        timestamp clock_in
        jsonb clock_in_location "lat,lng,accuracy"
        varchar clock_in_method "tap|nfc|qr|pin"
        timestamp clock_out
        jsonb clock_out_location
        varchar clock_out_method
        integer break_minutes
        integer total_minutes
        boolean is_verified
        varchar status "active|completed|disputed"
    }
    
    break_entries {
        uuid id PK
        text organization_id FK
        uuid time_entry_id FK
        timestamp break_start
        timestamp break_end
        varchar break_type "paid|unpaid"
    }
    
    correction_requests {
        uuid id PK
        text organization_id FK
        uuid time_entry_id FK
        text requested_by FK
        text reviewed_by FK
        jsonb original_data
        jsonb requested_data
        text reason
        varchar status "pending|approved|rejected"
        timestamp reviewed_at
    }
    
    compliance_checks {
        uuid id PK
        text organization_id FK
        text user_id FK
        varchar check_type "daily_limit|weekly_limit|rest_period|break_required"
        varchar check_result "pass|warning|violation"
        varchar severity "low|medium|high|critical"
        uuid time_entry_id FK
        uuid shift_id FK
        varchar rule_reference "Estatuto Art. 34.3"
        text message
        boolean resolved
        text resolved_by FK
    }
    
    generated_reports {
        uuid id PK
        text organization_id FK
        varchar report_type "monthly_timesheet|compliance|variance|inspector"
        varchar report_name
        timestamp period_start
        timestamp period_end
        text generated_by FK
        text file_path
        varchar file_hash "SHA-256"
        varchar access_level "internal|inspector|public"
        uuid inspector_token_id FK
    }
    
    notification_preferences {
        uuid id PK
        text user_id FK UK
        boolean dnd_enabled
        varchar dnd_start_time "22:00"
        varchar dnd_end_time "08:00"
        text dnd_days "array: saturday,sunday"
        boolean dnd_urgent_override
    }
    
    organization_settings {
        uuid id PK
        text organization_id FK UK
        numeric max_daily_hours "default: 9.0"
        numeric max_weekly_hours "default: 40.0"
        numeric min_rest_hours "default: 12.0"
        numeric break_required_after_hours "default: 6.0"
        integer min_break_minutes "default: 15"
        boolean geofence_enabled
        integer geofence_radius_meters
        boolean notify_compliance_violation
    }
    
    audit_log {
        uuid id PK
        text organization_id FK
        text actor_id FK
        varchar action "create|read|update|delete"
        varchar entity_type "shift|timeEntry|etc"
        uuid entity_id
        jsonb old_data
        jsonb new_data
        inet ip_address
        varchar prev_hash "SHA-256 of previous entry"
        varchar entry_hash "SHA-256 of this entry"
    }
    
    inspector_tokens {
        uuid id PK
        text organization_id FK
        varchar token_hash "SHA-256"
        text issued_by FK
        varchar issued_to "email"
        timestamp expires_at
        timestamp revoked_at
        timestamp last_used_at
    }
    
    monthly_summaries {
        uuid id PK
        text organization_id FK
        text user_id FK
        smallint year
        smallint month
        numeric total_hours
        integer total_days
        numeric overtime_hours
        text pdf_url
        timestamp generated_at
    }
    
    subscription_details {
        uuid id PK
        text organization_id FK UK
        varchar tier "starter|professional|enterprise"
        integer seat_count
        varchar subscription_status "active|past_due|cancelled|suspended"
        varchar stripe_customer_id
        varchar gocardless_customer_id
        uuid plan_id FK
    }
```

---

## üîó Foreign Key Relationships

### User ‚Üí Employee Profiles (One-to-One)
```sql
employee_profiles.user_id ‚Üí user.id (CASCADE)
employee_profiles.organization_id ‚Üí organization.id (CASCADE)
```
**Constraint**: Unique index on `(user_id, organization_id)` - one profile per user per org

---

### Organization ‚Üí All Business Tables (One-to-Many)
All RLS-protected tables have:
```sql
{table}.organization_id ‚Üí organization.id
```
**Purpose**: Enables Row-Level Security tenant isolation

**Tables with RLS**:
- locations, availability, shift_templates, shifts, swap_requests
- notifications, time_entries, break_entries, correction_requests
- monthly_summaries, audit_log, inspector_tokens
- employee_profiles, leave_requests, generated_reports, compliance_checks

---

### Shifts ‚Üí Time Entries (One-to-One or One-to-Many)
```sql
time_entries.linked_shift_id ‚Üí shifts.id (SET NULL)
```
**Behavior**:
- Scheduled shift ‚Üí Employee clocks in ‚Üí Creates `time_entry` linked to shift
- Ad-hoc clock-in (no shift) ‚Üí `linked_shift_id` is NULL
- One shift can have multiple time entries if employee clocks in/out multiple times (rare)

---

### Time Entries ‚Üí Break Entries (One-to-Many)
```sql
break_entries.time_entry_id ‚Üí time_entries.id (CASCADE)
```
**Behavior**:
- One time entry can have 0-N breaks
- Spanish law: Break required after 6 hours (enforced by compliance checks)

---

### Time Entries ‚Üí Correction Requests (One-to-Many)
```sql
correction_requests.time_entry_id ‚Üí time_entries.id (CASCADE)
```
**Behavior**:
- Employee forgot to clock in/out ‚Üí Creates correction request
- Manager approves ‚Üí Original `time_entry` updated + audit log entry created

---

### Shifts ‚Üí Swap Requests (Many-to-Many via Junction)
```sql
swap_requests.offered_shift_id ‚Üí shifts.id (CASCADE)
swap_requests.desired_shift_id ‚Üí shifts.id (SET NULL)
```
**Behavior**:
- Employee offers their shift + optionally requests specific shift in return
- Open swap: `desired_shift_id` is NULL (any colleague can claim)
- Direct swap: Both shifts specified

---

### Leave Requests ‚Üí User (Approval Chain)
```sql
leave_requests.user_id ‚Üí user.id (CASCADE)
leave_requests.approved_by ‚Üí user.id (SET NULL)
```
**Behavior**:
- Employee requests leave ‚Üí Manager approves
- Approved leave blocks shift assignments (roster builder checks this)

---

### Compliance Checks ‚Üí Time Entries/Shifts (Triggers)
```sql
compliance_checks.time_entry_id ‚Üí time_entries.id (SET NULL)
compliance_checks.shift_id ‚Üí shifts.id (SET NULL)
compliance_checks.resolved_by ‚Üí user.id (SET NULL)
```
**Behavior**:
- Automated checks run on clock-out, shift publish, weekly rollup
- Violations logged with Spanish law references
- Manager resolves with notes

---

### Generated Reports ‚Üí Inspector Tokens (Access Control)
```sql
generated_reports.inspector_token_id ‚Üí inspector_tokens.id (SET NULL)
```
**Behavior**:
- Inspector requests audit ‚Üí Manager generates token (valid 7 days)
- Reports tagged with token ‚Üí Inspector can access via read-only API

---

### Audit Log ‚Üí Previous Entry (Hash Chain)
```sql
audit_log.prev_hash ‚Üí audit_log.entry_hash (logical reference, not FK)
```
**Behavior**:
- Each entry's `entry_hash` = SHA-256(prev_hash + current_data)
- First entry: `prev_hash` is NULL
- Immutable: REVOKE UPDATE/DELETE on table
- Verification: Recalculate chain to detect tampering

---

## üîê Encrypted Fields

### employee_profiles (6 fields)

| Field | Type | Encryption | Purpose |
|-------|------|------------|---------|
| `dni_nie_encrypted` | text | AES-256-GCM | Spanish national ID (DNI/NIE) |
| `social_security_number_encrypted` | text | AES-256-GCM | Social Security Number (NSS) |
| `tax_id_encrypted` | text | AES-256-GCM | Tax ID (NIF/CIF) |
| `phone_number_encrypted` | text | AES-256-GCM | Contact phone number |
| `address_encrypted` | text | AES-256-GCM | JSONB address object (street, city, postal_code, country) |
| `emergency_contact_encrypted` | text | AES-256-GCM | JSONB contact object (name, phone, relationship) |

**Encryption Method**:
- Algorithm: AES-256-GCM (authenticated encryption)
- Key Derivation: PBKDF2 with 100,000 iterations
- Storage: Base64-encoded ciphertext
- Key Management: Environment variable `ENCRYPTION_KEY` (32-byte hex)

**Compliance**:
- GDPR Article 32: "Appropriate technical measures"
- Spanish LOPD-GDD: Personal data protection
- Encryption at rest + in transit (TLS 1.3)

**Access Control**:
- Only HR admins can decrypt (role-based)
- Audit log records all decryption events
- Inspector API: Encrypted fields redacted (shows `[ENCRYPTED]`)

---

## üìä Index Strategy

### Performance Indexes

**Foreign Key Indexes** (All FK columns indexed):
```sql
-- Example: time_entries table
CREATE INDEX time_entries_org_idx ON time_entries(organization_id);
CREATE INDEX time_entries_user_idx ON time_entries(user_id);
CREATE INDEX time_entries_entry_date_idx ON time_entries(entry_date);
CREATE INDEX time_entries_status_idx ON time_entries(status);
```

**Composite Indexes** (Common query patterns):
```sql
-- Roster queries: "Show shifts for org X, user Y, published only"
CREATE INDEX shifts_published_idx ON shifts(is_published, organization_id, user_id);

-- Compliance queries: "Show unresolved violations for org X"
CREATE INDEX compliance_checks_unresolved_idx ON compliance_checks(resolved, organization_id);

-- Leave requests: "Show pending requests for date range"
CREATE INDEX leave_requests_dates_idx ON leave_requests(start_date, end_date);
```

**Unique Indexes** (Data integrity):
```sql
-- One employee profile per user per org
CREATE UNIQUE INDEX employee_profiles_user_org_unique ON employee_profiles(user_id, organization_id);

-- One monthly summary per user per month
CREATE UNIQUE INDEX monthly_summaries_org_user_year_month_unique 
  ON monthly_summaries(organization_id, user_id, year, month);

-- One settings record per org
CREATE UNIQUE INDEX organization_settings_org_unique ON organization_settings(organization_id);
```

**Full-Text Search** (Future enhancement):
```sql
-- Search employees by name, job title, department
-- Not yet implemented (consider pg_trgm extension)
```

---

### Index Maintenance

**Monitoring**:
```sql
-- Check index usage
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan ASC;

-- Find unused indexes (idx_scan = 0)
```

**Optimization**:
- Rebuild indexes monthly: `REINDEX TABLE time_entries;`
- Vacuum analyze weekly: `VACUUM ANALYZE;`
- Monitor index bloat (pg_stat_user_tables)

---

## üõ°Ô∏è Row-Level Security (RLS) Policies

### Protected Tables (12)

**Business Tables**:
1. locations
2. availability
3. shift_templates
4. shifts
5. swap_requests
6. notifications
7. time_entries
8. break_entries
9. correction_requests
10. monthly_summaries
11. audit_log
12. inspector_tokens

**New Tables (Week 1)**:
13. employee_profiles
14. leave_requests
15. generated_reports
16. compliance_checks

---

### Policy Logic

**Standard RLS Policy** (Applied to all 16 tables):
```sql
-- Example: time_entries table
CREATE POLICY tenant_isolation ON time_entries
  USING (
    organization_id IN (
      SELECT organization_id 
      FROM member 
      WHERE user_id = auth.user_id()
    )
  );
```

**Explanation**:
- User can only access rows where `organization_id` matches their membership
- `auth.user_id()` is a custom function returning current session user ID
- Enforced at database level (cannot be bypassed by application code)

---

### Special Cases

**Inspector Tokens** (Read-Only Access):
```sql
-- Inspector can read all data for their organization via token
CREATE POLICY inspector_read ON time_entries FOR SELECT
  USING (
    organization_id IN (
      SELECT organization_id 
      FROM inspector_tokens 
      WHERE token_hash = current_setting('app.inspector_token')
        AND expires_at > NOW()
        AND revoked_at IS NULL
    )
  );
```

**Audit Log** (Immutable):
```sql
-- Prevent updates/deletes (only INSERT allowed)
REVOKE UPDATE, DELETE ON audit_log FROM PUBLIC;
GRANT INSERT, SELECT ON audit_log TO authenticated_users;
```

---

## üìà Data Volume Estimates

### Growth Projections (Per Organization)

| Table | Year 1 | Year 3 | Year 5 | Retention |
|-------|--------|--------|--------|-----------|
| `time_entries` | 10,000 | 30,000 | 50,000 | 7 years (legal) |
| `break_entries` | 4,000 | 12,000 | 20,000 | 7 years |
| `shifts` | 2,000 | 6,000 | 10,000 | 7 years |
| `audit_log` | 50,000 | 150,000 | 250,000 | 7 years |
| `compliance_checks` | 5,000 | 15,000 | 25,000 | 7 years |
| `leave_requests` | 200 | 600 | 1,000 | 7 years |
| `employee_profiles` | 50 | 100 | 150 | Active only |
| `notifications` | 5,000 | 15,000 | 25,000 | 90 days |

**Total Database Size** (Year 5, 100 orgs):
- Estimated: 50-100 GB
- With indexes: 75-150 GB
- Backup size (compressed): 20-40 GB

---

### Archival Strategy

**Hot Data** (Active queries):
- Last 12 months in primary tables
- Indexed for fast queries

**Warm Data** (Occasional access):
- 1-3 years old ‚Üí Partitioned tables
- Reduced indexes

**Cold Data** (Compliance only):
- 3-7 years old ‚Üí Archive tables
- Compressed, minimal indexes
- Restored on-demand for ITSS audits

**Purge Policy**:
- After 7 years: Legal retention met ‚Üí Anonymize or delete
- GDPR Right to Erasure: Encrypt with lost key (crypto-shredding)

---

## üîç Query Patterns

### Common Queries (Optimized)

**1. Live Attendance Dashboard**
```sql
-- "Who's clocked in right now at La Torre?"
SELECT u.name, te.clock_in, te.clock_in_location
FROM time_entries te
JOIN user u ON te.user_id = u.id
WHERE te.organization_id = 'org_123'
  AND te.location_id = 'loc_456'
  AND te.clock_out IS NULL
  AND te.entry_date = CURRENT_DATE
ORDER BY te.clock_in DESC;

-- Uses indexes: time_entries_org_idx, time_entries_entry_date_idx
-- Execution time: <10ms
```

---

**2. Monthly Payroll Export**
```sql
-- "All hours worked in January 2026 for payroll"
SELECT 
  u.name,
  u.email,
  ep.employee_number,
  SUM(te.total_minutes) / 60.0 AS total_hours,
  SUM(CASE WHEN te.total_minutes > 540 THEN (te.total_minutes - 540) / 60.0 ELSE 0 END) AS overtime_hours
FROM time_entries te
JOIN user u ON te.user_id = u.id
JOIN employee_profiles ep ON ep.user_id = u.id
WHERE te.organization_id = 'org_123'
  AND te.entry_date >= '2026-01-01'
  AND te.entry_date < '2026-02-01'
  AND te.status = 'completed'
GROUP BY u.id, u.name, u.email, ep.employee_number
ORDER BY u.name;

-- Uses indexes: time_entries_org_idx, time_entries_entry_date_idx
-- Execution time: <100ms (1000 entries)
```

---

**3. Compliance Violations (Unresolved)**
```sql
-- "Show all unresolved compliance violations"
SELECT 
  cc.check_type,
  cc.severity,
  cc.message,
  u.name AS employee_name,
  cc.checked_at
FROM compliance_checks cc
JOIN user u ON cc.user_id = u.id
WHERE cc.organization_id = 'org_123'
  AND cc.resolved = FALSE
  AND cc.severity IN ('high', 'critical')
ORDER BY cc.severity DESC, cc.checked_at DESC;

-- Uses index: compliance_checks_unresolved_idx
-- Execution time: <20ms
```

---

**4. Shift Roster (Next 7 Days)**
```sql
-- "Show all published shifts for next week"
SELECT 
  s.start_time,
  s.end_time,
  u.name AS assigned_to,
  l.name AS location,
  s.status
FROM shifts s
LEFT JOIN user u ON s.user_id = u.id
JOIN locations l ON s.location_id = l.id
WHERE s.organization_id = 'org_123'
  AND s.is_published = TRUE
  AND s.start_time >= NOW()
  AND s.start_time < NOW() + INTERVAL '7 days'
ORDER BY s.start_time, l.name;

-- Uses index: shifts_published_idx
-- Execution time: <30ms
```

---

## üîó References

- [Complete System Architecture](./TORRETEMPO_V4_COMPLETE_SYSTEM_ARCHITECTURE.md) - Full technical specification
- [Implementation Checklist](./IMPLEMENTATION_CHECKLIST.md) - Week-by-week development plan
- [README.md](../README.md) - Project overview and quick start
- [Drizzle Schema](../apps/api/src/db/schema.ts) - TypeScript schema definitions

---

## üìù Schema Change Log

### Version 4.0.0 (February 8, 2026)
- ‚úÖ Added 6 new tables: `employee_profiles`, `leave_requests`, `generated_reports`, `compliance_checks`, `notification_preferences`, `organization_settings`
- ‚úÖ Added encryption support for 6 PII fields in `employee_profiles`
- ‚úÖ Added RLS policies for all new tables
- ‚úÖ Added composite indexes for common query patterns
- ‚úÖ Added Spanish labor law compliance fields

### Version 3.0.0 (January 2026)
- Initial Phase 1 schema with 26 tables
- Better Auth integration (7 tables)
- Core business logic (19 tables)
- SHA-256 audit chain implementation

---

## üöÄ Future Enhancements

### Planned (Phase 2-6)

**Phase 2: Roster Engine**
- Add `roster_conflicts` table (track scheduling conflicts)
- Add `shift_preferences` table (employee preferred shifts)

**Phase 3: Advanced Reporting**
- Add `report_templates` table (custom report definitions)
- Add `scheduled_reports` table (automated report generation)

**Phase 4: Integrations**
- Add `integration_configs` table (Sage, A3, external systems)
- Add `webhook_logs` table (outbound webhook tracking)

**Phase 5: Mobile Enhancements**
- Add `device_registrations` table (push notification tokens)
- Add `offline_queue` table (sync pending actions)

**Phase 6: Analytics**
- Add `labor_metrics` table (pre-calculated KPIs)
- Add `forecast_models` table (predictive scheduling)

---

**Document Version**: 1.0  
**Author**: System Architect  
**Last Review**: February 8, 2026  
**Next Review**: March 2026 (after Phase 2 completion)
